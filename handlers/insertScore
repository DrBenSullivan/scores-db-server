//Define function to post score to database.
const mysql = require("mysql2");

const insertScore = (request, response) => {
    const body = request.body;

    //Validate name to ensure contains exactly 3 upper-case alphabetic characters.
    if (!/^[A-Z]{3}$/.test(body.name)) {
        return response.status(400).json({ message: `Bad request: Name must be exactly 3 upper-case alphabetic characters` });
    };

    connection.query(

        'INSERT INTO highscores ( name, score, date ) VALUES ( ? , ? , ? )',
        [ body.name , body.score , body.date ],

        function (postError, results, fields) {
            if (postError) {
                console.log(`Error adding highscore to database: ${postError}`);
                return response.status(500).json({ error: `Error adding highscore to database: ${postError}`});
            }

            const newId = results.insertId;

            const newRank = connection.query(

                'SELECT id, name, score, date, RANK() OVER (ORDER BY score DESC) AS rank FROM highscores WHERE id = ?',
                [ newId ],

            )
            response.status(201).json({ message: `Entry successfully added to database`, entryId: results.insertId, requestBody: request.body, rank: newRank });
        }  
    );
};